(()=>{"use strict";class t{static rand(){const t=[l.MOVE,l.ROTATE_CLOCKWISE,l.ROTATE_COUNTERCLOCKWISE,l.EAT,l.EAT_SOLAR,l.CLONE,l.OVERPOPULATION];return t[Math.floor(Math.random()*t.length)]}static execute(t,c){if(!0===t.processing)return;t.processing=!0;const h={[l.MOVE]:e,[l.ROTATE_CLOCKWISE]:s,[l.ROTATE_COUNTERCLOCKWISE]:o,[l.EAT]:r,[l.EAT_SOLAR]:i,[l.CLONE]:a,[l.OVERPOPULATION]:n};t.program.current>=t.program.commands.length&&(t.program.current=t.program.commands.length-1);const d=t.program.commands[t.program.current];void 0!==d&&(t.program.current++,t.program.current>=t.program.commands.length&&(t.program.current=0),h[d].execute(t,c),d===l.EAT_SOLAR&&n.execute(t,c))}}class e{static execute(t,e){const{x:s,y:o}=x.frontPosition(t),r=e.getCell(s,o);x.get(r)?t.options={...t.options,hasBotInFront:!0}:(e.setCellProps(s,o,{bot:t},e.map),delete e.getCell(t.x,t.y).bot,t.x=s,t.y=o,t.options={...t.options,hasBotInFront:!1})}}class s{static execute(t,e){t.direction=s.rotate(t.direction,1)}static rotate(t,e){return t+e&3}}class o{static execute(t,e){t.direction=o.rotate(t.direction,-1)}static rotate(t,e){return t+e&3}}class r{static execute(t,e){const s=e.getCell(t.x,t.y);s.resources.food&&(t.xp+=100,t.xp>255&&(t.xp=255),delete s.resources.food)}}class i{static execute(t,e){const s=e.getCell(t.x,t.y);t.xp+=3*s.resources.light.power}}class a{static execute(t,e){const s=x.backPosition(t),o=e.getCell(s.x,s.y);if(x.get(o))return;if(t.xp<2*x.DEFAULT_XP)return;t.xp/=2;const r=x.cloneBot(t,{...s,id:x.generateId(),direction:a.turn(t.direction),xp:x.DEFAULT_XP});e.addBot(r.x,r.y,r)}static turn(t){return t/90+2&3}}class n{static execute(t,e){let s=0;e.eachNeighborBot(t,e,(t=>{s++})),t.xp-=s/3}}class c{static generate(){const e=[];for(let s=0;s<10;s++)e.push(t.rand());return{commands:e,current:0}}static step(e,s){t.execute(e,s)}}const l={MOVE:0,ROTATE_CLOCKWISE:1,ROTATE_COUNTERCLOCKWISE:2,EAT:3,EAT_SOLAR:4,CLONE:5,OVERPOPULATION:6};class h{static MUTATION_PROBABILITY=.001;static mutate(t){if(Math.random()>h.MUTATION_PROBABILITY)return;const e=[(t,e)=>this.mutateSubstitution(t,e),(t,e)=>this.mutateDeletion(t,e),(t,e)=>this.mutateInsertion(t,e)],s=Math.floor(Math.random()*t.program.commands.length);e.random()(t.program.commands,s),t.style.h=this.randomChangeStyleComponent(t.style.h),t.style.s=this.randomChangeStyleComponent(t.style.s),t.style.v=this.randomChangeStyleComponent(t.style.v)}static randomChangeStyleComponent(t){const e=.01;let s=Math.random()>.5?1:-1;return(t+e*s<=0||t+e*s>=1)&&(s*=-1),t+e*s}static mutateSubstitution(t,e){return t[e]=this.randomOperationCode(),t}static mutateDeletion(t,e){return t.splice(e,1),t}static mutateInsertion(t,e){return t.splice(e,0,this.randomOperationCode()),t}static randomOperationsPosition(t){return Math.floor(Math.random()*bot.program.commands.length)}static randomOperationCode(){return Object.values(l).random()}}const d=40,m=20;class u{constructor(t,e){this.width=t,this.height=e,this.initCells(),window.debugWorld=this}static validateCoords(t,e){if(t>=d||t<0)throw"x should be from 0 to 40";if(e>=m||e<0)throw"x should be from 0 to 40"}static normalizeCoords(t,e){return t<0&&(t=39),t>39&&(t=0),e<0&&(e=19),e>19&&(e=0),{x:t,y:e}}eachCell(t){for(let e=0;e<this.width;e++)for(let s=0;s<this.height;s++)t(e,s)}eachBot(t){this.eachCell(((e,s)=>{const o=x.get(this.getCell(e,s));o&&t(o)}))}eachNeighborBot(t,e,s){for(let o=-1;o<=1;o++)for(let r=-1;r<=1;r++)if(0!==o&&0!==r){const i=u.normalizeCoords(t.x+o,t.y+r),a=e.getCell(i.x,i.y),n=x.get(a);n&&x.isProcessing(n)&&s(n)}}populate(){this.eachCell(((t,e)=>{Math.random()>.9&&this.addBot(t,e,x.generateRandom(t,e))}))}populateTest1(){TEST_CASES[2].forEach((t=>{this.addBot(t.x,t.y,t)}))}initResources(t){this.eachCell(((e,s)=>{if(Math.random()>.9){let o=g.generateRandom();g.add(e,s,o,t)}let o={light:{type:"light",power:1-s/m}};g.add(e,s,o,t)}))}step(){this.eachBot((t=>{h.mutate(t),c.step(t,this),x.liveStep(t),x.tryDie(t,this)})),this.eachBot((t=>t.processing=!1))}destroyBot(t){delete this.getCell(t.x,t.y).bot}getCell(t,e){return this.map[t][e]}setCellProps(t,e,s,o){o[t][e]={...o[t][e],...s}}initCell(t,e,s){void 0===s&&(s={resources:{}}),void 0===this.map[t]&&(this.map[t]=[]),this.map[t][e]=s}initCells(){this.map=[],this.eachCell(((t,e)=>{this.initCell(t,e)}))}addBot(t,e,s){if(u.validateCoords(t,e),this.map[t][e].bot)throw`Bot already exists in cell ${t}:${e}`;this.map[t][e].bot=s}print(){let t="";for(let e=0;e<this.height;e++){for(let s=0;s<this.width;s++)t+=this.map[s][e].bot?1:".";t+="\n"}}}class g{static add(t,e,s,o){u.validateCoords(t,e),o[t][e].resources={...o[t][e].resources,...s}}static generateRandom(){return{food:{type:"food"}}}}const p={x:0,y:0,direction:0,id:null,rotate:1,program:{commands:[],current:0},options:{},xp:127,style:{h:1,s:1,b:1}};function C(t){return t.push(t.shift()),t}class x{static DEFAULT_XP=10;static generateRandom(t,e){return{...p,id:x.generateId(),x:t,y:e,direction:Math.floor(4*Math.random()),rotate:Math.random()>.5?1:-1,program:c.generate(),options:{},style:{h:Math.random(),s:Math.random(),v:Math.random()}}}static get(t){return t.bot}static frontPosition(t){const e=[[1,0],[0,-1],[-1,0],[0,1]][t.direction];return u.normalizeCoords(t.x+e[0],t.y+e[1])}static backPosition(t){const e=C(C([[1,0],[0,-1],[-1,0],[0,1]]))[t.direction];return u.normalizeCoords(t.x+e[0],t.y+e[1])}static cloneBot(t,e={}){return{...JSON.parse(JSON.stringify(t)),...e}}static generateId(){return""+Math.random()}static liveStep(t){t.xp--}static tryDie(t,e){if(t.xp<=0){e.destroyBot(t);const s=g.generateRandom();g.add(t.x,t.y,s,e.map)}}static isProcessing(t){return 0==t.processing}}class w{constructor(t){this.world=t,this.size=10;const e=document.getElementById("cnv");e.width=d*this.size,e.height=m*this.size,this.ctx=e.getContext("2d")}redraw(){const t=this.ctx.createImageData(d*this.size,m*this.size);for(let e=0;e<d*this.size*m*this.size*4;e+=4)t.data[e]=0,t.data[e+1]=0,t.data[e+2]=0,t.data[e+3]=255;this.world.eachCell(((e,s)=>{const o=this.world.getCell(e,s);o.resources&&(o.resources.food,this.drawResource(e,s,o.resources,t))})),this.world.eachBot((e=>{this.drawBot(e,t)})),this.ctx.putImageData(t,0,0)}drawResource(t,e,s,o){if(s.food){t*=this.size,e*=this.size;const s={r:140,g:80,b:0};this.writeImageDataResource(t,e,s,o)}}writeImageDataResource(t,e,s,o){for(let r=t+3;r<t+this.size-3;r++)for(let t=e+3;t<e+this.size-3;t++)this.writeImageDataPixel(r,t,s,o)}drawBot(t,e){let s;s=function(t,e,s){let o,r,i,a,n,c,l,h;switch(1===arguments.length&&(e=t.s,s=t.v,t=t.h),a=Math.floor(6*t),n=6*t-a,c=s*(1-e),l=s*(1-n*e),h=s*(1-(1-n)*e),a%6){case 0:o=s,r=h,i=c;break;case 1:o=l,r=s,i=c;break;case 2:o=c,r=s,i=h;break;case 3:o=c,r=l,i=s;break;case 4:o=h,r=c,i=s;break;case 5:o=s,r=c,i=l}return{r:Math.round(255*o),g:Math.round(255*r),b:Math.round(255*i)}}(t.style.h,t.style.s,t.style.v);const o=(t=this.setColor(t)).x*this.size,r=t.y*this.size;this.writeImageDataBot(o,r,t.direction,s,e)}setColor(t){return t}writeImageDataBot(t,e,s,o,r){for(let s=e+1;s<e+this.size-1;s+=1)this.writeImageDataPixel(t,s,o,r),this.writeImageDataPixel(t+this.size-1,s,o,r);for(let s=t+1;s<t+this.size-1;s+=1)this.writeImageDataPixel(s,e,o,r),this.writeImageDataPixel(s,e+this.size-1,o,r);for(let s=t+1;s<t+this.size-1;s++)for(let t=e+1;t<e+this.size-1;t++)this.writeImageDataPixel(s,t,o,r)}writeImageDataPixel(t,e,s,o){let r=e*(d*this.size*4)+4*t+0;o.data[r]=s.r,r++,o.data[r]=s.g,r++,o.data[r]=s.b,r++,o.data[r]=void 0===s.a?255:s.a}}let f=0;class y{constructor(t){if(!t)throw Error("Invalid argument world");this.world=t,this.drawer=new w(t)}step(){let t=performance.now();this.world.step(),t=performance.now()-t,f++;let e=performance.now();this.drawer.redraw(),e=performance.now()-e,f%30==0&&console.log(`${f} ${Date.now()} perf: ${t}, ${e} milliseconds`),requestAnimationFrame((()=>this.step()))}stepBusinessLogic(){return console.log(Date.now()),new Promise(((t,e)=>{this.world.step(),this.drawer.redraw(),t()})).then((t=>{this.stepBusinessLogic()}))}stepRedraw(){}run(){this.stepBusinessLogic(),this.initDebugWindow()}initDebugWindow(){const t=document.getElementById("cnv");document.getElementById("info"),t.addEventListener("mousedown",(e=>{const s=t.clientWidth/d,o=t.clientHeight/m,r=parseInt(e.x/s),i=parseInt(e.y/o);this.debugOptions={botX:r,botY:i}})),requestAnimationFrame((()=>this.updateDebugWindow()))}updateDebugWindow(){if(this.debugOptions){const t=document.getElementById("info"),e=debugWorld.getCell(this.debugOptions.botX,this.debugOptions.botY);let s=x.get(e);s||(s={x:"",y:"",xp:"",program:"",id:""});let o="";o+=`x: ${s.x}</br>`,o+=`y: ${s.y}</br>`,o+=`xp: ${Math.floor(s.xp)}</br>`,o+=`program: ${s.program.commands}</br>`,o+=`id: ${s.id}</br>`,t.innerHTML=o}requestAnimationFrame((()=>this.updateDebugWindow()))}}Array.prototype.random=function(){return this[Math.floor(Math.random()*this.length)]},function(){const t=class{static create(){const t=new u(d,m);return t.populate(),t.initResources(t.map),t}}.create();new y(t).run()}()})();
//# sourceMappingURL=main.js.map