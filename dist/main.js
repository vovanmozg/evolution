(()=>{"use strict";function t(t,e){return t<0&&(t=99),t>99&&(t=0),e<0&&(e=39),e>39&&(e=0),{x:t,y:e}}const e=[[1,0],[0,-1],[-1,0],[0,1]],o=(t,e,o)=>o&&o[t]&&o[t][e]&&o[t][e].bot;function n(t){return t.push(t.shift()),t}const r=(t,e,o)=>(delete o[t][e].bot,o);function i(t,e,o,n){if(((t,e)=>{if(t>=100||t<0)throw new Error("x should be from 0 to 100");if(e>=40||e<0)throw new Error("x should be from 0 to 100")})(t,e),n[t][e].bot)throw new Error(`Bot already exists in cell ${t}:${e}`);return n[t][e].bot=o,n}function s(t,e,o){return o[t][e]}const a={x:0,y:0,direction:0,id:null,rotate:1,program:{commands:[],current:0},options:{},xp:127,style:{h:1,s:1,b:1}};function c(t){return!1===t.processing}function u(){return`${Math.random()}`}function d(t,e,o){return{...a,id:u(),x:t,y:e,direction:Math.floor(4*Math.random()),rotate:Math.random()>.5?1:-1,program:o(),options:{},style:{h:Math.random(),s:Math.random(),v:Math.random()}}}function m(t){t.xp-=1}function h(t,e,o){t.xp<=0&&(r(t.x,t.y,e.map),o(t,e.map))}const l={generateId:u,generateRandom:d,liveStep:m,tryDie:h,cloneBot:function(t,e={}){return{x:void 0===e.x?t.x:e.x,y:void 0===e.y?t.y:e.y,id:void 0===e.id?t.id:e.id,direction:void 0===e.direction?t.direction:e.direction,xp:void 0===e.xp?t.xp:e.xp,rotate:t.rotate,program:{commands:t.program.commands.slice(),current:t.program.current},options:{...t.options},style:{h:t.style.h,s:t.style.s,v:t.style.v},processing:t.processing}},isProcessing:c,DEFAULT_BOT:a,RIGHT:0,TOP:1,LEFT:2,BOTTOM:3,DEFAULT_XP:10};function f(t,e,o,n){n[t][e].resources={...n[t][e].resources,...o}}const p={MOVE:0,CLONE:1,EAT:2,EAT_SOLAR:3,ROTATE_CLOCKWISE:4,ROTATE_COUNTERCLOCKWISE:5,OVERPOPULATION:6};function g(t){return t[Math.floor(Math.random()*t.length)]}function x(){return g(Object.values(p))}function y(t){const e=.01;let o=Math.random()>.5?1:-1;return(t+e*o<=0||t+e*o>=1)&&(o*=-1),t+e*o}const w={execute:function(n,i){const s=function(o){const n=e[o.direction];return t(o.x+n[0],o.y+n[1])}(n);n.options.hasBotInFront=!!o(s.x,s.y,i.map),n.options.hasBotInFront||function(t,e,n){if(o(e.x,e.y,n))throw new Error(`Bot in cell ${e.x}:${e.y} already exists`);((t,e,o,n)=>{n[t][e]={...n[t][e],...o}})(e.x,e.y,{bot:t},n),r(t.x,t.y,n),t.x=e.x,t.y=e.y}(n,s,i.map)}},E={execute:function(t,e){t.direction=t.direction+1&3}},O={execute:function(t,e){t.direction=t.direction+-1&3}},T={execute:function(t,e){const o=s(t.x,t.y,e.map);o.resources.food&&(t.xp+=100,t.xp>255&&(t.xp=255),delete o.resources.food)}},I={execute:function(t,e){const o=s(t.x,t.y,e.map);t.xp+=3*o.resources.light.power}},b={execute:function(r,s){const a=function(o){const r=n(n(e))[o.direction];return t(o.x+r[0],o.y+r[1])}(r);if(o(a.x,a.y,s.map))return;if(r.xp<2*l.DEFAULT_XP)return;r.xp/=2;const c=l.cloneBot(r,{...a,id:l.generateId(),direction:(u=r.direction,u+2&3),xp:l.DEFAULT_XP});var u;i(c.x,c.y,c,s.map)}},M={execute:function(e,n){let r=0;!function(e,n,i,s){for(let i=-1;i<=1;i+=1)for(let a=-1;a<=1;a+=1)if(0!==i&&0!==a){const c=t(e.x+i,e.y+a),u=o(c.x,c.y,n.map);u&&s(u)&&(r+=1)}}(e,n,0,c),e.xp-=(t=>t/3)(r)}},v=function(t,e){if(!0===t.processing)return;t.processing=!0;const o={[p.MOVE]:w,[p.ROTATE_CLOCKWISE]:E,[p.ROTATE_COUNTERCLOCKWISE]:O,[p.EAT]:T,[p.EAT_SOLAR]:I,[p.CLONE]:b,[p.OVERPOPULATION]:M};t.program.current>=t.program.commands.length&&(t.program.current=t.program.commands.length-1);const n=t.program.commands[t.program.current];void 0!==n&&(t.program.current+=1,t.program.current>=t.program.commands.length&&(t.program.current=0),o[n].execute(t,e),n===p.EAT_SOLAR&&M.execute(t,e))},A=function(){const t=[p.MOVE,p.ROTATE_CLOCKWISE,p.ROTATE_COUNTERCLOCKWISE,p.EAT,p.EAT_SOLAR,p.CLONE,p.OVERPOPULATION];return t[Math.floor(Math.random()*t.length)]};function C(){const t=[];for(let e=0;e<10;e+=1)t.push(A());return{commands:t,current:0}}function L(t,e){for(let t=0;t<100;t+=1)for(let o=0;o<40;o+=1)e(t,o)}function R(t,e){L(0,((n,r)=>{const i=o(n,r,t.map);i&&e(i)}))}function D(t){R(t,(e=>{(function(t){if(Math.random()>.001)return;const e=[(t,e)=>function(t,e){return t[e]=x(),t}(t,e),(t,e)=>function(t,e){return t.splice(e,1),t}(t,e),(t,e)=>function(t,e){return t.splice(e,0,x()),t}(t,e)],o=Math.floor(Math.random()*t.program.commands.length);g(e)(t.program.commands,o),t.style.h=y(t.style.h),t.style.s=y(t.style.s),t.style.v=y(t.style.v)})(e),function(t,e){v(t,e)}(e,t),m(e),h(e,t,((t,e)=>{f(t.x,t.y,{food:{type:"food"}},e)}))})),function(t){R(t,(t=>{t.processing=!1}))}(t)}const P=(t,e,o)=>t>=o[0]&&t<=o[2]&&e>=o[1]&&e<=o[3];class z{constructor(t){this.world=t,this.size=10;const e=document.getElementById("cnv");this.ctx=e.getContext("2d"),this.ctx.imageSmoothingEnabled=!1,e.width=100*this.size,e.height=40*this.size}redraw(){const t=this.ctx.createImageData(100*this.size,40*this.size);for(let e=0;e<100*this.size*40*this.size*4;e+=4)t.data[e]=0,t.data[e+1]=0,t.data[e+2]=0,t.data[e+3]=255;L(this.world,((e,o)=>{const n=s(e,o,this.world.map);n.resources&&this.drawResource(e,o,n.resources,t)})),R(this.world,(e=>{this.drawBot(e,t)})),this.ctx.putImageData(t,0,0)}drawResource(t,e,o,n){if(o.food){t*=this.size,e*=this.size;const o={r:140,g:80,b:0};this.writeImageDataResource(t,e,o,n)}}writeImageDataResource(t,e,o,n){for(let r=t+3;r<t+this.size-3;r+=1)for(let t=e+3;t<e+this.size-3;t+=1)this.writeImageDataPixel(r,t,o,n)}getColor(t){const e=[0,.15,.3,.45,.6,.75,.9],o=t.program.commands.map((t=>e[t])),n=o.reduce(((t,e)=>t+e),0)/o.length||0;return function(t,e,o){let n,r,i;1===arguments.length&&(e=t.s,o=t.v,t=t.h);const s=Math.floor(6*t),a=6*t-s,c=o*(1-e),u=o*(1-a*e),d=o*(1-(1-a)*e);switch(s%6){case 0:n=o,r=d,i=c;break;case 1:n=u,r=o,i=c;break;case 2:n=c,r=o,i=d;break;case 3:n=c,r=u,i=o;break;case 4:n=d,r=c,i=o;break;case 5:n=o,r=c,i=u}return{r:Math.round(255*n),g:Math.round(255*r),b:Math.round(255*i)}}(t.style.h,t.style.s,n)}drawBot(t,e){const o=this.getColor(t),n=t.x*this.size,r=t.y*this.size;this.writeImageDataBot(n,r,t,t.direction,o,e)}setColor(t){return t}writeImageDataBot(t,e,o,n,r,i){const s=t+1,a=t+this.size-2,c=e+1,u=e+this.size-2,d=t,m=t+this.size-1,h=e,f=e+this.size-1,p={[l.RIGHT]:[m-1,h+4,m,f-4],[l.TOP]:[d+4,h,m-4,h+1],[l.LEFT]:[d,h+4,d+1,f-4],[l.BOTTOM]:[d+4,f-1,m-4,f]}[n];for(let t=c;t<=u;t+=1)P(d,t,p)||this.writeImageDataPixel(d,t,r,i),P(m,t,p)||this.writeImageDataPixel(m,t,r,i);for(let t=s;t<=a;t+=1)P(t,h,p)||this.writeImageDataPixel(t,h,r,i),P(t,f,p)||this.writeImageDataPixel(t,f,r,i);for(let t=s;t<=a;t+=1)for(let e=c;e<=u;e+=1)P(t,e,p)||this.writeImageDataPixel(t,e,r,i)}writeImageDataPixel(t,e,o,n){let r=100*e*this.size*4+4*t;n.data[r]=o.r,r+=1,n.data[r]=o.g,r+=1,n.data[r]=o.b,r+=1,n.data[r]=void 0===o.a?255:o.a}}const B={};let $,S=0;const _=document.getElementById("cnv"),F=document.getElementById("info"),N=_.clientWidth/100,U=_.clientHeight/40,W=()=>{void 0!==B.botX&&void 0!==B.botY&&(B.bot=o(B.botX,B.botY,$.map))},K=t=>{B.botX=parseInt(t.x/N,10),B.botY=parseInt(t.y/U,10),W()};function V(){const{bot:t}=B;void 0===t||t&&t.xp<=0?W():F.innerHTML=`x: ${t.x}</br>y: ${t.y}</br>xp: ${parseInt(t.xp,10)}</br>program: ${t.program.commands}</br>id: ${t.id}</br>`}function X(t){$=t,_.addEventListener("mousedown",K),setInterval(V,1e3)}String.prototype.hashCode=function(){var t,e=0;if(0===this.length)return e;for(t=0;t<this.length;t++)e=(e<<5)-e+this.charCodeAt(t),e|=0;return e};var k=[.05,.5,.2,.7,.9,.3,.9,.9999,.1,.43,.31,.88,.99,.8],H=0;let Y;function q(t,e){const o=performance.now();return t(e),performance.now()-o}function G(t){!function(t){S+=1;const e=JSON.stringify(window.debugWorld).hashCode();window.debugInfo1=`${S} ${e} ${Date.now()} perf: ${t[0]}, ${t[1]} milliseconds`,V()}([q(D,t),q(Y)]),requestAnimationFrame((()=>G(t)))}Math.random=function(){const t=k[H];return(H+=1)>k.length-1&&(H=0),t},Math.random;const j=function(){const t=function(){const t={map:[]};return function(t){L(0,((e,o)=>{!function(t,e,o,n={resources:{}}){void 0===o[t]&&(o[t]=[]),o[t][e]=n}(e,o,t.map)}))}(t),function(t){L(0,((e,o)=>{Math.random()>.9&&i(e,o,d(e,o,C),t.map)}))}(t),function(t){L(0,((e,o)=>{Math.random()>.9&&f(e,o,{food:{type:"food"}},t.map),f(e,o,{light:{type:"light",power:1-o/40}},t.map)}))}(t),window.debugWorld=t,t}();!function(t,e){Y=e.redraw.bind(e),requestAnimationFrame((()=>G(t))),setInterval((()=>{console.log(Date.now(),window.debugInfo1)}),1e3),X(t)}(t,new z(t))};j()})();
//# sourceMappingURL=main.js.map